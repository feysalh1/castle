{% extends "base.html" %}

{% block title %}Photo Gallery - Children's Castle{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/photos.css') }}">
{% endblock %}

{% block content %}
<div class="photo-gallery-container">
    <h1 class="gallery-title">My Photo Gallery</h1>
    
    <div class="gallery-actions">
        <a href="{{ url_for('photos.upload_photo') }}" class="upload-btn">
            <i class="fas fa-upload"></i> Upload Photo
        </a>
        
        <div class="view-options">
            <button class="view-btn grid-view active" data-view="grid">
                <i class="fas fa-th"></i>
            </button>
            <button class="view-btn list-view" data-view="list">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>
    
    <div class="filters">
        <select id="filter-type" class="filter-select">
            <option value="all">All Photos</option>
            <option value="favorites">Favorites</option>
            {% if user_type == 'parent' %}
            <option value="my-photos">My Photos</option>
            <option value="children-photos">Children's Photos</option>
            {% endif %}
        </select>
        
        <div class="search-bar">
            <input type="text" id="photo-search" placeholder="Search by title, tags...">
            <button id="search-btn"><i class="fas fa-search"></i></button>
        </div>
    </div>
    
    {% if photos %}
        <div class="photo-grid" id="photo-container">
            {% for photo in photos %}
                <div class="photo-item" 
                     data-id="{{ photo.id }}" 
                     data-title="{{ photo.title or 'Untitled' }}" 
                     data-tags="{{ photo.tags or '' }}"
                     data-owner="{{ 'parent' if photo.parent_id else 'child' }}"
                     data-favorite="{{ 'true' if photo.is_favorite else 'false' }}">
                    <div class="photo-wrapper">
                        <img src="{{ url_for('photos.get_raw_photo', photo_id=photo.id) }}" 
                             alt="{{ photo.title or 'Photo' }}"
                             loading="lazy">
                        
                        <div class="photo-overlay">
                            <button class="favorite-btn {% if photo.is_favorite %}active{% endif %}" 
                                    data-id="{{ photo.id }}">
                                <i class="{% if photo.is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
                            </button>
                            
                            <a href="{{ url_for('photos.view_photo', photo_id=photo.id) }}" class="view-btn">
                                <i class="fas fa-eye"></i>
                            </a>
                            
                            <button class="delete-btn" data-id="{{ photo.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="photo-info">
                        <h3 class="photo-title">{{ photo.title or 'Untitled' }}</h3>
                        <div class="photo-meta">
                            {% if photo.child_id %}
                                <span class="owner-badge child">Child's Photo</span>
                            {% else %}
                                <span class="owner-badge parent">Parent's Photo</span>
                            {% endif %}
                            
                            {% if photo.is_private %}
                                <span class="privacy-badge private">Private</span>
                            {% else %}
                                <span class="privacy-badge shared">Shared</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <img src="{{ url_for('static', filename='images/icons/photos-empty.svg') }}" 
                 alt="No photos" class="empty-icon">
            <h2>No Photos Yet</h2>
            <p>Upload your first photo to start your collection!</p>
            <a href="{{ url_for('photos.upload_photo') }}" class="btn primary-btn">
                <i class="fas fa-upload"></i> Upload Photo
            </a>
        </div>
    {% endif %}
</div>

<!-- Confirm Delete Modal -->
<div class="modal" id="delete-confirm-modal">
    <div class="modal-content">
        <h3>Delete Photo?</h3>
        <p>Are you sure you want to delete this photo? This action cannot be undone.</p>
        <div class="modal-actions">
            <button id="cancel-delete" class="btn cancel-btn">Cancel</button>
            <button id="confirm-delete" class="btn delete-btn">Delete</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View options (grid/list)
    const viewBtns = document.querySelectorAll('.view-btn');
    const photoContainer = document.getElementById('photo-container');
    
    viewBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const viewType = this.dataset.view;
            
            // Remove active class from all buttons
            viewBtns.forEach(b => b.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Update container class
            photoContainer.className = viewType === 'grid' ? 'photo-grid' : 'photo-list';
        });
    });
    
    // Filtering
    const filterSelect = document.getElementById('filter-type');
    const searchInput = document.getElementById('photo-search');
    const searchBtn = document.getElementById('search-btn');
    
    function filterPhotos() {
        const filterValue = filterSelect.value;
        const searchValue = searchInput.value.toLowerCase();
        const photoItems = document.querySelectorAll('.photo-item');
        
        photoItems.forEach(item => {
            let showItem = true;
            
            // Filter by type
            if (filterValue === 'favorites' && item.dataset.favorite !== 'true') {
                showItem = false;
            } else if (filterValue === 'my-photos' && item.dataset.owner !== 'parent') {
                showItem = false;
            } else if (filterValue === 'children-photos' && item.dataset.owner !== 'child') {
                showItem = false;
            }
            
            // Filter by search
            if (searchValue && showItem) {
                const title = item.dataset.title.toLowerCase();
                const tags = item.dataset.tags.toLowerCase();
                
                if (!title.includes(searchValue) && !tags.includes(searchValue)) {
                    showItem = false;
                }
            }
            
            // Show or hide the item
            item.style.display = showItem ? 'block' : 'none';
        });
    }
    
    filterSelect.addEventListener('change', filterPhotos);
    searchBtn.addEventListener('click', filterPhotos);
    searchInput.addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            filterPhotos();
        }
    });
    
    // Favorite button functionality
    const favoriteBtns = document.querySelectorAll('.favorite-btn');
    
    favoriteBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const photoId = this.dataset.id;
            
            fetch(`/photos/toggle-favorite/${photoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the button appearance
                    const icon = this.querySelector('i');
                    
                    if (data.is_favorite) {
                        this.classList.add('active');
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                    } else {
                        this.classList.remove('active');
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                    }
                    
                    // Update the data attribute for filtering
                    this.closest('.photo-item').dataset.favorite = data.is_favorite;
                }
            })
            .catch(error => {
                console.error('Error toggling favorite:', error);
            });
        });
    });
    
    // Delete functionality
    const deleteBtns = document.querySelectorAll('.delete-btn');
    const deleteModal = document.getElementById('delete-confirm-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    let currentPhotoId = null;
    
    deleteBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            currentPhotoId = this.dataset.id;
            deleteModal.style.display = 'flex';
        });
    });
    
    cancelDeleteBtn.addEventListener('click', function() {
        deleteModal.style.display = 'none';
        currentPhotoId = null;
    });
    
    confirmDeleteBtn.addEventListener('click', function() {
        if (currentPhotoId) {
            fetch(`/photos/delete/${currentPhotoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the photo element from the DOM
                    const photoElement = document.querySelector(`.photo-item[data-id="${currentPhotoId}"]`);
                    if (photoElement) {
                        photoElement.remove();
                    }
                    
                    // Close the modal
                    deleteModal.style.display = 'none';
                    currentPhotoId = null;
                    
                    // Show empty state if no photos left
                    const remainingPhotos = document.querySelectorAll('.photo-item');
                    if (remainingPhotos.length === 0) {
                        location.reload(); // Reload to show empty state
                    }
                }
            })
            .catch(error => {
                console.error('Error deleting photo:', error);
            });
        }
    });
    
    // Close modal if clicked outside
    window.addEventListener('click', function(event) {
        if (event.target === deleteModal) {
            deleteModal.style.display = 'none';
            currentPhotoId = null;
        }
    });
});
</script>
{% endblock %}